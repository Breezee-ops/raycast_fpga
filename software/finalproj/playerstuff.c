#include "playerstuff.h"
#include <stdbool.h>
#include <math.h>
// screenwidth = 320;

void raycast(struct player him){
	int map[64] = {
			1,1,1,1,1,1,1,1,
			1,0,0,0,0,0,0,1,
			1,0,0,0,1,0,0,1,
			1,0,0,0,1,0,0,1,
			1,0,0,0,0,0,0,1,
			1,0,0,0,0,0,0,1,
			1,0,0,0,0,0,0,1,
			1,1,1,1,1,1,1,1
	};
	int COS[360] = {
			32,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			30,
			30,
			30,
			30,
			30,
			30,
			29,
			29,
			29,
			29,
			29,
			28,
			28,
			28,
			27,
			27,
			27,
			27,
			26,
			26,
			26,
			25,
			25,
			25,
			24,
			24,
			24,
			23,
			23,
			23,
			22,
			22,
			21,
			21,
			20,
			20,
			20,
			19,
			19,
			18,
			18,
			17,
			17,
			16,
			16,
			16,
			15,
			15,
			14,
			14,
			13,
			13,
			12,
			11,
			11,
			10,
			10,
			9,
			9,
			8,
			8,
			7,
			7,
			6,
			6,
			5,
			5,
			4,
			3,
			3,
			2,
			2,
			1,
			1,
			0,
			0,
			0,
			-1,
			-1,
			-2,
			-2,
			-3,
			-3,
			-4,
			-5,
			-5,
			-6,
			-6,
			-7,
			-7,
			-8,
			-8,
			-9,
			-9,
			-10,
			-10,
			-11,
			-11,
			-12,
			-13,
			-13,
			-14,
			-14,
			-15,
			-15,
			-15,
			-16,
			-16,
			-17,
			-17,
			-18,
			-18,
			-19,
			-19,
			-20,
			-20,
			-20,
			-21,
			-21,
			-22,
			-22,
			-23,
			-23,
			-23,
			-24,
			-24,
			-24,
			-25,
			-25,
			-25,
			-26,
			-26,
			-26,
			-27,
			-27,
			-27,
			-27,
			-28,
			-28,
			-28,
			-29,
			-29,
			-29,
			-29,
			-29,
			-30,
			-30,
			-30,
			-30,
			-30,
			-30,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-32,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-30,
			-30,
			-30,
			-30,
			-30,
			-30,
			-29,
			-29,
			-29,
			-29,
			-29,
			-28,
			-28,
			-28,
			-27,
			-27,
			-27,
			-27,
			-26,
			-26,
			-26,
			-25,
			-25,
			-25,
			-24,
			-24,
			-24,
			-23,
			-23,
			-23,
			-22,
			-22,
			-21,
			-21,
			-20,
			-20,
			-20,
			-19,
			-19,
			-18,
			-18,
			-17,
			-17,
			-16,
			-16,
			-16,
			-15,
			-15,
			-14,
			-14,
			-13,
			-13,
			-12,
			-11,
			-11,
			-10,
			-10,
			-9,
			-9,
			-8,
			-8,
			-7,
			-7,
			-6,
			-6,
			-5,
			-5,
			-4,
			-3,
			-3,
			-2,
			-2,
			-1,
			-1,
			0,
			0,
			0,
			1,
			1,
			2,
			2,
			3,
			3,
			4,
			5,
			5,
			6,
			6,
			7,
			7,
			8,
			8,
			9,
			9,
			10,
			10,
			11,
			11,
			12,
			13,
			13,
			14,
			14,
			15,
			15,
			16,
			16,
			16,
			17,
			17,
			18,
			18,
			19,
			19,
			20,
			20,
			20,
			21,
			21,
			22,
			22,
			23,
			23,
			23,
			24,
			24,
			24,
			25,
			25,
			25,
			26,
			26,
			26,
			27,
			27,
			27,
			27,
			28,
			28,
			28,
			29,
			29,
			29,
			29,
			29,
			30,
			30,
			30,
			30,
			30,
			30,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31
			};



	int SIN[360] = {
			0,
			0,
			1,
			1,
			2,
			2,
			3,
			3,
			4,
			5,
			5,
			6,
			6,
			7,
			7,
			8,
			8,
			9,
			9,
			10,
			10,
			11,
			11,
			12,
			13,
			13,
			14,
			14,
			15,
			15,
			15,
			16,
			16,
			17,
			17,
			18,
			18,
			19,
			19,
			20,
			20,
			20,
			21,
			21,
			22,
			22,
			23,
			23,
			23,
			24,
			24,
			24,
			25,
			25,
			25,
			26,
			26,
			26,
			27,
			27,
			27,
			27,
			28,
			28,
			28,
			29,
			29,
			29,
			29,
			29,
			30,
			30,
			30,
			30,
			30,
			30,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			32,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			31,
			30,
			30,
			30,
			30,
			30,
			30,
			29,
			29,
			29,
			29,
			29,
			28,
			28,
			28,
			27,
			27,
			27,
			27,
			26,
			26,
			26,
			25,
			25,
			25,
			24,
			24,
			24,
			23,
			23,
			23,
			22,
			22,
			21,
			21,
			20,
			20,
			20,
			19,
			19,
			18,
			18,
			17,
			17,
			16,
			16,
			15,
			15,
			15,
			14,
			14,
			13,
			13,
			12,
			11,
			11,
			10,
			10,
			9,
			9,
			8,
			8,
			7,
			7,
			6,
			6,
			5,
			5,
			4,
			3,
			3,
			2,
			2,
			1,
			1,
			0,
			0,
			0,
			-1,
			-1,
			-2,
			-2,
			-3,
			-3,
			-4,
			-5,
			-5,
			-6,
			-6,
			-7,
			-7,
			-8,
			-8,
			-9,
			-9,
			-10,
			-10,
			-11,
			-11,
			-12,
			-13,
			-13,
			-14,
			-14,
			-15,
			-15,
			-16,
			-16,
			-16,
			-17,
			-17,
			-18,
			-18,
			-19,
			-19,
			-20,
			-20,
			-20,
			-21,
			-21,
			-22,
			-22,
			-23,
			-23,
			-23,
			-24,
			-24,
			-24,
			-25,
			-25,
			-25,
			-26,
			-26,
			-26,
			-27,
			-27,
			-27,
			-27,
			-28,
			-28,
			-28,
			-29,
			-29,
			-29,
			-29,
			-29,
			-30,
			-30,
			-30,
			-30,
			-30,
			-30,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-32,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-31,
			-30,
			-30,
			-30,
			-30,
			-30,
			-30,
			-29,
			-29,
			-29,
			-29,
			-29,
			-28,
			-28,
			-28,
			-27,
			-27,
			-27,
			-27,
			-26,
			-26,
			-26,
			-25,
			-25,
			-25,
			-24,
			-24,
			-24,
			-23,
			-23,
			-23,
			-22,
			-22,
			-21,
			-21,
			-20,
			-20,
			-20,
			-19,
			-19,
			-18,
			-18,
			-17,
			-17,
			-16,
			-16,
			-16,
			-15,
			-15,
			-14,
			-14,
			-13,
			-13,
			-12,
			-11,
			-11,
			-10,
			-10,
			-9,
			-9,
			-8,
			-8,
			-7,
			-7,
			-6,
			-6,
			-5,
			-5,
			-4,
			-3,
			-3,
			-2,
			-2,
			-1,
			-1,
			0
			};
	for(int col = 0; col < 320; col++){
		int fDistwall = 0;
		int offsetfov =(him.angoff - 1440) + (((col<<5) * 9)>>5);
//		printf("angle: %d", col);
		if(offsetfov<0){
			offsetfov = offsetfov + 11520;
		}
		int eyex = SIN[offsetfov>>5];
		int eyey = COS[offsetfov>>5];
		int hitwall = 0;
//		printf("off fov: %d", offsetfov);
		while(hitwall == 0 && fDistwall < 256){
			fDistwall = fDistwall + 8;
			int testx =  ((him.xoff) + ((eyex * fDistwall)>>5))>>5;
			int testy =  ((him.yoff) + ((eyey * fDistwall)>>5))>>5;
//			int val = (map[(testx) + (testy * 8)]);
//			printf("val: %d \n", val);
			if(testx<0 || testx>=8 || testy<0 || testy>=8){
//				printf("entered loop \n");
				hitwall = 1;
				fDistwall = 256;
//			} if(testx < 0) {
//				printf("exited loop \n");
//
//			} else if ((testx < 0) && (testx >= 8)){
//				printf("enited loop \n");
			}
			else if (map[(testx) + (testy<<3)] == 1){
//				int idx = (testx) + (testy<<3);
				hitwall = true;
			}
//			printf("testx: %d", testx);
//			printf("testy: %d", testy);
//			printf("idx: %d", ((testx) + (testy<<3)));
		}

		int nCeil = 7680 - 245760/fDistwall;
		vga_ctrl->VRAM[col] = nCeil;
	}
}
